{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///Users/sphealmeon/my-chesshacks-bot/my-chesshacks-bot/devtools/app/api/server.ts"],"sourcesContent":["import { spawn } from \"child_process\";\nimport http from \"http\";\nimport path from \"path\";\nimport fs from \"fs\";\n\nexport const runtime = \"nodejs\";\n\nlet serverProcess: ReturnType<typeof spawn> | null = null;\nlet serverReadyPromise: Promise<void> | null = null;\nlet watcher: fs.FSWatcher | null = null;\nlet restartTimeout: NodeJS.Timeout | null = null;\nlet stoppingPromise: Promise<void> | null = null;\nlet restarting = false;\nlet lastRestartAt: number | null = null;\nlet lastRestartReason: \"manual\" | \"file-change\" | null = null;\n\nconst servePort = Number(process.env.SERVE_PORT || \"5058\");\n\nconsole.log(\"[devtools env]\", {\n  PYTHON_EXECUTABLE: process.env.PYTHON_EXECUTABLE,\n  PYTHON: process.env.PYTHON,\n  SERVE_PORT: process.env.SERVE_PORT,\n  PORT: process.env.PORT\n});\n\nfunction getServerCwd() {\n  return path.join(process.cwd(), \"..\");\n}\n\nfunction setupWatcher() {\n  if (watcher) {\n    return;\n  }\n\n  const serverCwd = getServerCwd();\n  const srcDir = path.join(serverCwd, \"src\");\n\n  if (!fs.existsSync(srcDir)) {\n    return;\n  }\n\n  try {\n    watcher = fs.watch(srcDir, { recursive: true }, () => {\n      console.log(\n        \"Detected change in src directory, scheduling serve.py restart\"\n      );\n      if (restartTimeout) {\n        clearTimeout(restartTimeout);\n      }\n      restartTimeout = setTimeout(() => {\n        restartServer(\"file-change\");\n      }, 300);\n    });\n  } catch (err) {\n    console.error(\"Failed to watch src directory for changes\", err);\n  }\n}\n\nfunction stopServer(): Promise<void> {\n  if (!serverProcess) {\n    serverReadyPromise = null;\n    return Promise.resolve();\n  }\n\n  if (stoppingPromise) {\n    return stoppingPromise;\n  }\n\n  const current = serverProcess;\n\n  stoppingPromise = new Promise<void>((resolve) => {\n    current.once(\"exit\", () => {\n      serverProcess = null;\n      serverReadyPromise = null;\n      stoppingPromise = null;\n      resolve();\n    });\n\n    if (!current.killed) {\n      current.kill();\n    }\n  });\n\n  return stoppingPromise;\n}\n\nfunction startServer() {\n  if (serverProcess && !serverProcess.killed) {\n    return;\n  }\n\n  const serverCwd = getServerCwd();\n  const pythonExecutable =\n    process.env.PYTHON_EXECUTABLE || process.env.PYTHON || \"python3\";\n\n  setupWatcher();\n\n  console.log(\"Starting serve.py process\", { pythonExecutable, serverCwd });\n  try {\n    serverProcess = spawn(pythonExecutable, [\"-u\", \"serve.py\"], {\n      cwd: serverCwd,\n      stdio: [\"ignore\", \"pipe\", \"pipe\"],\n      shell: false\n    });\n\n    if (serverProcess.stdout) {\n      serverProcess.stdout.on(\"data\", (data) => {\n        const text = data.toString();\n        if (text.trim().length > 0) {\n          console.log(\"[serve.py stdout]\", text.trimEnd());\n        }\n      });\n    }\n\n    if (serverProcess.stderr) {\n      serverProcess.stderr.on(\"data\", (data) => {\n        const text = data.toString();\n        if (text.trim().length > 0) {\n          console.error(\"[serve.py stderr]\", text.trimEnd());\n        }\n      });\n    }\n  } catch (err) {\n    console.error(\"Failed to spawn serve.py\", err);\n    serverProcess = null;\n    serverReadyPromise = null;\n    throw err;\n  }\n\n  serverProcess.on(\"exit\", () => {\n    console.log(\"serve.py process exited\");\n    serverProcess = null;\n    serverReadyPromise = null;\n  });\n}\n\nfunction waitForServerReady(): Promise<void> {\n  if (serverReadyPromise) return serverReadyPromise;\n\n  console.log(\"Waiting for serve.py to become ready\");\n  serverReadyPromise = new Promise((resolve, reject) => {\n    const maxAttempts = 30;\n    const delayMs = 200;\n    let attempts = 0;\n\n    const check = () => {\n      console.log(\"Checking serve.py readiness\", { attempts });\n      attempts += 1;\n\n      const req = http.request(\n        {\n          host: \"127.0.0.1\",\n          port: servePort,\n          path: \"/\",\n          method: \"POST\"\n        },\n        (res) => {\n          if (res.statusCode && res.statusCode >= 200 && res.statusCode < 300) {\n            console.log(\"serve.py is ready\");\n            resolve();\n          } else if (attempts < maxAttempts) {\n            setTimeout(check, delayMs);\n          } else {\n            reject(new Error(\"serve.py did not become ready\"));\n          }\n        }\n      );\n\n      req.on(\"error\", (err) => {\n        console.error(\"Error checking serve.py readiness\");\n        if (attempts < maxAttempts) {\n          setTimeout(check, delayMs);\n        } else {\n          reject(new Error(\"serve.py did not become ready\"));\n        }\n      });\n\n      req.end();\n    };\n\n    check();\n  });\n\n  return serverReadyPromise;\n}\n\nexport async function ensureServerRunning() {\n  if (!serverProcess || serverProcess.killed) {\n    startServer();\n  }\n  await waitForServerReady();\n}\n\nexport async function restartServer(reason?: \"manual\" | \"file-change\") {\n  if (restarting) {\n    return;\n  }\n  restarting = true;\n  console.log(\"Restarting serve.py process\");\n  lastRestartAt = Date.now();\n  lastRestartReason = reason ?? null;\n  await stopServer();\n  startServer();\n  restarting = false;\n}\n\nexport function getLastRestartInfo() {\n  return {\n    lastRestartAt,\n    lastRestartReason\n  };\n}\n"],"names":[],"mappings":";;;;;;;;;;AAAA;AACA;AACA;AACA;;;;;AAEO,MAAM,UAAU;AAEvB,IAAI,gBAAiD;AACrD,IAAI,qBAA2C;AAC/C,IAAI,UAA+B;AACnC,IAAI,iBAAwC;AAC5C,IAAI,kBAAwC;AAC5C,IAAI,aAAa;AACjB,IAAI,gBAA+B;AACnC,IAAI,oBAAqD;AAEzD,MAAM,YAAY,OAAO,QAAQ,GAAG,CAAC,UAAU,IAAI;AAEnD,QAAQ,GAAG,CAAC,kBAAkB;IAC5B,mBAAmB,QAAQ,GAAG,CAAC,iBAAiB;IAChD,QAAQ,QAAQ,GAAG,CAAC,MAAM;IAC1B,YAAY,QAAQ,GAAG,CAAC,UAAU;IAClC,MAAM,QAAQ,GAAG,CAAC,IAAI;AACxB;AAEA,SAAS;IACP,OAAO,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI;AAClC;AAEA,SAAS;IACP,IAAI,SAAS;QACX;IACF;IAEA,MAAM,YAAY;IAClB,MAAM,SAAS,4GAAI,CAAC,IAAI,CAAC,WAAW;IAEpC,IAAI,CAAC,wGAAE,CAAC,UAAU,CAAC,SAAS;QAC1B;IACF;IAEA,IAAI;QACF,UAAU,wGAAE,CAAC,KAAK,CAAC,QAAQ;YAAE,WAAW;QAAK,GAAG;YAC9C,QAAQ,GAAG,CACT;YAEF,IAAI,gBAAgB;gBAClB,aAAa;YACf;YACA,iBAAiB,WAAW;gBAC1B,cAAc;YAChB,GAAG;QACL;IACF,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,6CAA6C;IAC7D;AACF;AAEA,SAAS;IACP,IAAI,CAAC,eAAe;QAClB,qBAAqB;QACrB,OAAO,QAAQ,OAAO;IACxB;IAEA,IAAI,iBAAiB;QACnB,OAAO;IACT;IAEA,MAAM,UAAU;IAEhB,kBAAkB,IAAI,QAAc,CAAC;QACnC,QAAQ,IAAI,CAAC,QAAQ;YACnB,gBAAgB;YAChB,qBAAqB;YACrB,kBAAkB;YAClB;QACF;QAEA,IAAI,CAAC,QAAQ,MAAM,EAAE;YACnB,QAAQ,IAAI;QACd;IACF;IAEA,OAAO;AACT;AAEA,SAAS;IACP,IAAI,iBAAiB,CAAC,cAAc,MAAM,EAAE;QAC1C;IACF;IAEA,MAAM,YAAY;IAClB,MAAM,mBACJ,QAAQ,GAAG,CAAC,iBAAiB,IAAI,QAAQ,GAAG,CAAC,MAAM,IAAI;IAEzD;IAEA,QAAQ,GAAG,CAAC,6BAA6B;QAAE;QAAkB;IAAU;IACvE,IAAI;QACF,gBAAgB,IAAA,4HAAK,EAAC,kBAAkB;YAAC;YAAM;SAAW,EAAE;YAC1D,KAAK;YACL,OAAO;gBAAC;gBAAU;gBAAQ;aAAO;YACjC,OAAO;QACT;QAEA,IAAI,cAAc,MAAM,EAAE;YACxB,cAAc,MAAM,CAAC,EAAE,CAAC,QAAQ,CAAC;gBAC/B,MAAM,OAAO,KAAK,QAAQ;gBAC1B,IAAI,KAAK,IAAI,GAAG,MAAM,GAAG,GAAG;oBAC1B,QAAQ,GAAG,CAAC,qBAAqB,KAAK,OAAO;gBAC/C;YACF;QACF;QAEA,IAAI,cAAc,MAAM,EAAE;YACxB,cAAc,MAAM,CAAC,EAAE,CAAC,QAAQ,CAAC;gBAC/B,MAAM,OAAO,KAAK,QAAQ;gBAC1B,IAAI,KAAK,IAAI,GAAG,MAAM,GAAG,GAAG;oBAC1B,QAAQ,KAAK,CAAC,qBAAqB,KAAK,OAAO;gBACjD;YACF;QACF;IACF,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,gBAAgB;QAChB,qBAAqB;QACrB,MAAM;IACR;IAEA,cAAc,EAAE,CAAC,QAAQ;QACvB,QAAQ,GAAG,CAAC;QACZ,gBAAgB;QAChB,qBAAqB;IACvB;AACF;AAEA,SAAS;IACP,IAAI,oBAAoB,OAAO;IAE/B,QAAQ,GAAG,CAAC;IACZ,qBAAqB,IAAI,QAAQ,CAAC,SAAS;QACzC,MAAM,cAAc;QACpB,MAAM,UAAU;QAChB,IAAI,WAAW;QAEf,MAAM,QAAQ;YACZ,QAAQ,GAAG,CAAC,+BAA+B;gBAAE;YAAS;YACtD,YAAY;YAEZ,MAAM,MAAM,4GAAI,CAAC,OAAO,CACtB;gBACE,MAAM;gBACN,MAAM;gBACN,MAAM;gBACN,QAAQ;YACV,GACA,CAAC;gBACC,IAAI,IAAI,UAAU,IAAI,IAAI,UAAU,IAAI,OAAO,IAAI,UAAU,GAAG,KAAK;oBACnE,QAAQ,GAAG,CAAC;oBACZ;gBACF,OAAO,IAAI,WAAW,aAAa;oBACjC,WAAW,OAAO;gBACpB,OAAO;oBACL,OAAO,IAAI,MAAM;gBACnB;YACF;YAGF,IAAI,EAAE,CAAC,SAAS,CAAC;gBACf,QAAQ,KAAK,CAAC;gBACd,IAAI,WAAW,aAAa;oBAC1B,WAAW,OAAO;gBACpB,OAAO;oBACL,OAAO,IAAI,MAAM;gBACnB;YACF;YAEA,IAAI,GAAG;QACT;QAEA;IACF;IAEA,OAAO;AACT;AAEO,eAAe;IACpB,IAAI,CAAC,iBAAiB,cAAc,MAAM,EAAE;QAC1C;IACF;IACA,MAAM;AACR;AAEO,eAAe,cAAc,MAAiC;IACnE,IAAI,YAAY;QACd;IACF;IACA,aAAa;IACb,QAAQ,GAAG,CAAC;IACZ,gBAAgB,KAAK,GAAG;IACxB,oBAAoB,UAAU;IAC9B,MAAM;IACN;IACA,aAAa;AACf;AAEO,SAAS;IACd,OAAO;QACL;QACA;IACF;AACF"}},
    {"offset": {"line": 275, "column": 0}, "map": {"version":3,"sources":["file:///Users/sphealmeon/my-chesshacks-bot/my-chesshacks-bot/devtools/app/api/reload/status/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { getLastRestartInfo } from \"../../server\";\n\nexport const runtime = \"nodejs\";\n\nexport async function GET() {\n  const info = getLastRestartInfo();\n  return NextResponse.json(info);\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAEO,MAAM,UAAU;AAEhB,eAAe;IACpB,MAAM,OAAO,IAAA,mLAAkB;IAC/B,OAAO,uLAAY,CAAC,IAAI,CAAC;AAC3B"}}]
}